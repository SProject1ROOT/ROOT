<html>
<head>
<style>
	canvas { 
		display: inline-block; 
		background: white; 
		box-shadow: 0px 0px 10px grey;
	}
</style>

<script language="javascript">
window.onload = init;
var context;
var bufferLoader;
var arrayBufferList = new Array();
var playingBufferSource;
var isPlaying = false;
var gainNode = null;

var pos = 0;

///////////////////////////////////////
function BufferLoader(context, urlList, callback) {
	this.context = context;
	this.urlList = urlList;
	this.onload = callback;
	this.bufferList = new Array();
	this.loadCount = 0;
}

BufferLoader.prototype.loadBuffer = function(url, index) {
  // Load buffer asynchronously
  var request = new XMLHttpRequest();
  request.open("GET", url, true);
  request.responseType = "arraybuffer";

  var loader = this;

  request.onload = function() {
    // Asynchronously decode the audio file data in request.response
    loader.context.decodeAudioData(
      request.response,
      function(buffer) {
        if (!buffer) {
          alert('error decoding file data: ' + url);
          return;
        }
        loader.bufferList[index] = buffer;
        if (++loader.loadCount == loader.urlList.length)
          loader.onload(loader.bufferList);
      },
      function(error) {
        console.error('decodeAudioData error', error);
      }
    );
  }

  request.onerror = function() {
    alert('BufferLoader: XHR error');
  }

  request.send();
}

BufferLoader.prototype.load = function() {
  for (var i = 0; i < this.urlList.length; ++i)
  this.loadBuffer(this.urlList[i], i);
}
///////////////////////////////////////

function changeVolume(element)
{
	var volume = element.value;
	var fraction = parseInt(element.value) / parseInt(element.max);
	gainNode.gain.value = fraction * fraction;
}

function init() {

	document.body.onkeyup = function(event){
		event = event || window.event;
		var keycode = event.charCode || event.keyCode;
		if(keycode == 32)
		{
			if(isPlaying == false)
			{
				// play
				gainNode = context.createGain();
				
				playingBufferSource = context.createBufferSource();
				playingBufferSource.buffer = arrayBufferList[0];
				
				playingBufferSource.connect(gainNode);
				
				gainNode.connect(context.destination);
				
				//playingBufferSource.connect(context.destination);
				playingBufferSource.start(-5);
				
				isPlaying = true;
			}
			else
			{
				playingBufferSource.stop(0);
				
				isPlaying = false;
			}
		
		}
	}


  // Fix up prefixing
  window.AudioContext = window.AudioContext || window.webkitAudioContext;
  context = new AudioContext();

  bufferLoader = new BufferLoader(
    context,
    [
      '/audio/Adelle_Someone_Like_You.mp3',
	  '/audio/The_Beatles_Let_it_be.mp3'
    ],
    finishedLoading
    );

  bufferLoader.load(); 
}

function drawBuffer( width, height, context, data ) {	
    var step = Math.ceil( data.length / width );
    var amp = height / 2;
	
	context.fillStyle = "#333333";
	context.clearRect(0,0,width,height);
    for(var i=0; i < width; i++){
        var min = 1.0;
        var max = -1.0;
        for (j=0; j<step; j++) {
            var datum = data[(i*step)+j]; 
            if (datum < min)
                min = datum;
            if (datum > max)
                max = datum;
        }
        context.fillRect(i,(1+min)*amp,1,Math.max(1,(max-min)*amp));
		
		//alert(i + ", " + (0+min)*amp + ", " + 1 + ", " + Math.max(1,(max-min)*amp));
    }
}


function finishedLoading(bufferList) {
	// Create two sources and play them both together.
	source1 = context.createBufferSource();
	source1.buffer = bufferList[0];
	
	arrayBufferList = bufferList;

	var canvas1 = document.getElementById( "wavedisplay1" );
	var bufferdata1 = source1.buffer.getChannelData(0);
	drawBuffer( canvas1.width, canvas1.height, canvas1.getContext('2d'), bufferdata1);
}

</script>
</head>
<body>
	<!--input type="button" value="sound" onclick="sound();"/>
	<input type="button" value="draw" onclick="draw();"/><br-->
	<div id="test1" style="position: relative;">
		<canvas id="wavedisplay1" height="100" width="800" style="position: absolute; left: 0; top: 0; z-index: 0;" onmousedown="canvas_mousedown(this)"></canvas>
		<canvas id="wavedisplay1_play" height="100" width="800" onmousedown="canvas_mousedown(this)" style="position: absolute; left: 0; top: 0; z-index: 1; background:transparent;"></canvas>
		<script type='text/javascript'>
			var canvas = document.getElementById('wavedisplay1_play');
			var ctx = canvas.getContext('2d');
			canvas.onmousedown = function(event) {
				ctx.clearRect(0, 0, canvas.width, canvas.height)
				pos = event.x;
				
				ctx.beginPath();
				ctx.lineWidth = 1;
				ctx.moveTo(pos, 0);
				ctx.lineTo(pos, 0);
				ctx.lineTo(pos, canvas.height);
				
				ctx.strokeStyle = "#ff0000";
				ctx.stroke();
			
			}
		</script>
	</div>
	<br><br><br><br><br><br><br><br>
	<input type="range" min="0" max="100" value="100" oninput="changeVolume(this);">
	<br>
	<input type="button" value="pos" onclick="alert(pos);">
</body>

</html>