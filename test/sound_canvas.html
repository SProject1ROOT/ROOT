<html>
<head>
<style>
	canvas { 
		display: inline-block; 
		background: white; 
		box-shadow: 0px 0px 10px grey;
	}
</style>

<script src="make_element.js"></script>
<script src="http://code.jquery.com/jquery-latest.js"></script>
<script type="text/javascript" src="/test/buffer_loader.js"></script>
<script type="text/javascript">
window.onload = init;

var context;
var playingBS;
var isPlaying = false;
var gainNode = null;

var pos = 0;

var startOffset = 0;
var startTime = 0;
var timer;

var dragdrop_pos = -1;
var new_pos = 0;


var playStartTime;

var AudioDataList = new Array();
function AudioData(ab, s, v)
{
	this.audioBuffer = ab;
	this.startPos = s;
	this.volume = v;
}


function changeVolume(element)
{
	var volume = element.value;
	var fraction = parseInt(element.value) / parseInt(element.max);
	gainNode.gain.value = fraction * fraction;
}

function init() {

	document.body.onkeyup = function(event){
		event = event || window.event;
		var keycode = event.charCode || event.keyCode;
		if(keycode == 32)
		{
			if(isPlaying == false)
			{
				startTime = context.currentTime;
				
				// play
				gainNode = context.createGain();
				
				playingBS = context.createBufferSource();
				playingBS.buffer = AudioDataList[0].audioBuffer;
				
				playingBS.connect(gainNode);
				
				gainNode.connect(context.destination);
				
				//playingBS.connect(context.destination);
				
				playingBS.start(0, (pos / 800) * playingBS.buffer.duration);
				
				isPlaying = true;
				
				//new_pos = pos;
				
				timer = window.setInterval("drawCanvasPlayBar()", 50);
				
				playStartTime = new Date().getMilliseconds();
			}
			else
			{
				playingBS.stop(0);
				playingBS.disconnect();
				gainNode.disconnect();
				
				startOffset += context.currentTime - startTime;
				
				isPlaying = false;
				
				window.clearInterval(timer);
				drawCanvasPlayBar()
			}
		
		}
		else if(keycode == 32)
		{
		}
		
		
	}

	// Fix up prefixing
	window.AudioContext = window.AudioContext || window.webkitAudioContext;
	context = new AudioContext();

	var bufferLoader = new BufferLoader(
		context,
		[
			'/audio/damienrice.mp3',
			'/audio/Adelle_Someone_Like_You.mp3'
		],
		function(bufferList){
			for (var i = 0; i < bufferList.length; i++) {
				AudioDataList[i] = new AudioData(bufferList[i], 0, 0)
				makeMusicCanvas(i, "100px", "400px");
			}
			drawCanvasWave();
		}
	);

	bufferLoader.load(); 
}

function drawCanvasPlayBar()
{
	var canvas = document.getElementById('wavedisplay_play');
	var ctx = canvas.getContext('2d');
	
	ctx.clearRect(0, 0, canvas.width, canvas.height)
	
	if( isPlaying ) {
		new_pos = pos + ((context.currentTime - startTime) / playingBS.buffer.duration * canvas.width);
		
		ctx.beginPath();
		ctx.lineWidth = 1;
		ctx.moveTo(new_pos, 0);
		ctx.lineTo(new_pos, 0);
		ctx.lineTo(new_pos, canvas.height);
		
		ctx.strokeStyle = "#ff0000";
		ctx.stroke();
	}
		
}

function drawCanvasWave() {
	for (var a = 0; a < AudioDataList.length; a++)
	{
		var canvas = document.getElementById("wavedisplay" + (a));
		var ctx = canvas.getContext("2d");
		var width = canvas.width;
		var height = canvas.height;
		var data = AudioDataList[a].audioBuffer.getChannelData(0);
		
		var step = Math.ceil( data.length / width );
		var amp = height / 2;
		
		ctx.fillStyle = "grey";
		//ctx.fillStyle = "#333366";
		ctx.clearRect(0,0,width,height);
		for(var i=0; i < width; i++){
			var min = 1.0;
			var max = -1.0;
			for (j=0; j<step; j++) {
				var datum = data[(i*step)+j]; 
				if (datum < min)
					min = datum;
				if (datum > max)
					max = datum;
			}
			ctx.fillRect(i,(1+min)*amp,1,Math.max(1,(max-min)*amp));
		}
	}
}



</script>

</head>
<body>
	<!--input type="button" value="sound" onclick="sound();"/>
	<input type="button" value="draw" onclick="draw();"/><br-->
	<br>
	
	<input type="button" value="Play" onclick="alert(pos);">
	<input type="button" value="Stop" onclick="alert(pos);">
	<input type="button" value="Zoom in" onclick="alert(pos);">
	<input type="button" value="Zoom out" onclick="alert(pos);">
	<input type="button" value="make" onclick="makeMusicCanvas('wavedisplay1', '100px', '400px', '0px')">
	
	<br><br><br>
	<div id="canvas_container" style="position: relative;">
		<!--canvas id="wavedisplay1" height="100" width="400" style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas-->
		<!--canvas id="wavedisplay2" height="100" width="400" style="position: absolute; left: 0; top: 100; z-index: 1;"></canvas-->
		
		<canvas id="wavedisplay_play" height="200" width="1000" style="position: absolute; left: 0; top: 0; z-index: 0; background:transparent;"></canvas>
		
		<script type='text/javascript'>
			var canvas = $('wavedisplay1'); //document.getElementById('wavedisplay1');
			$('wavedisplay1').on({
				mousedown: function (event) {
					dragdrop_pos = event.x;
				},
				mousemove: function (event) {
					if( dragdrop_pos != -1 )
					{
						if( new_pos >= 0 && AudioDataList[0].startPos + (event.x - dragdrop_pos) + this.width < 1000 )
						{
							new_pos = AudioDataList[0].startPos + (event.x - dragdrop_pos);
							this.style.left = new_pos + "px";
						}
					}
				},
				mouseup: function (event) {
					AudioDataList[0].startPos = new_pos;
					dragdrop_pos = -1;
				}
			});
			
			/*canvas.onmousedown = function(event) {
				dragdrop_pos = event.x;
			}
			canvas.onmousemove = function(event) 
			{
				if( dragdrop_pos != -1 )
				{
					if( new_pos >= 0 && AudioDataList[0].startPos + (event.x - dragdrop_pos) + this.width < 1000 )
					{
						new_pos = AudioDataList[0].startPos + (event.x - dragdrop_pos);
						this.style.left = new_pos + "px";
					}
				}
			}
			canvas.onmouseup = function(event) {
				AudioDataList[0].startPos = new_pos;
				dragdrop_pos = -1;
				
				console.log("onmouseup startPos=" + this.style.left);
			}*/
			
			/*canvas = document.getElementById('wavedisplay2');
			canvas.onmousedown = function(event) {
				dragdrop_list[1] = event.x;
			}
			canvas.onmouseup = function(event) {
				dragdrop_list[1] = event.x;
			}*/
			
			canvas = document.getElementById('wavedisplay_play');
			var ctx = canvas.getContext('2d');
			canvas.onmousedown = function(event) {
				ctx.clearRect(0, 0, canvas.width, canvas.height)
				pos = event.x;
				
				ctx.beginPath();
				ctx.lineWidth = 1;
				ctx.moveTo(pos, 0);
				ctx.lineTo(pos, 0);
				ctx.lineTo(pos, canvas.height);
				
				ctx.strokeStyle = "#ff0000";
				ctx.stroke();
			}
		</script>
	</div>
	<input type="range" min="0" max="100" value="100" oninput="changeVolume(this);">
	<br>
	
</body>

</html>